from use_model import *
import os

def show_spectrograms(model, audio_file, max_duration):
    print("Loading input audio...", end="\r")
    data, sr = librosa.load(audio_file, sr=AUDIO_SAMPLE_RATE, mono=True)
    print("Input audio loaded.\t\t\t")
    
    for i, img in enumerate(cqt_image_generator(data, max_duration)):
        #plt.close("all")
        #plt.figure(figsize=(3, 4))
        #imgplot = plt.imshow(img, cmap="gray")
        #plt.show()
        cv2.imshow("img - " + str(i), img)
        cv2.waitKey(0)
        cv2.destroyAllWindows()
    

def audio_to_chords_to_audio(model, audio_file, max_duration, playback=False, save_to_file=None):
    print("Loading input audio...", end="\r")
    data, sr = librosa.load(audio_file, sr=AUDIO_SAMPLE_RATE, mono=True)
    print("Input audio loaded.\t\t\t")
    
    print("Computing chords...", end="\r")
    chords = [infer(model, img) for img in cqt_image_generator(data, max_duration)]
    print("Computed chords.\t\t\t")
    create_audio(chords, playback=playback, save_to_file=save_to_file)


if __name__ == "__main__":
    ############### Getting things ready ###############
    MAX_DURATION = 30

    print("Loading model...", end="\r")
    model = load_model() 
    print("Model loaded.\t\t")

    ############### Tests ###############

    #AUDIO_FILE = "00_BN1-129-Eb_comp_mic.wav"
    #test_chords = [[0, 7, 0, 8, 7, 0], [0, 7, 0, 8, 7, 0], [0, 7, 0, 8, 7, 0], [0, 7, 9, 0, 0, 0], [0, 7, 9, 0, 0, 0], [0, 7, 9, 8, 9, 0], [0, 7, 9, 8, 9, 0], [0, 7, 9, 8, 9, 0], [0, 7, 9, 8, 9, 0], [0, 7, 9, 8, 7, 0], [0, 7, 9, 8, 7, 0], [0, 7, 9, 8, 7, 0], [0, 7, 0, 8, 9, 0], [0, 7, 0, 8, 9, 0], [0, 7, 0, 8, 9, 0], [0, 7, 9, 8, 9, 0], [0, 7, 9, 8, 9, 0], [0, 7, 9, 8, 0, 0], [0, 7, 9, 8, 7, 9], [0, 7, 9, 8, 7, 9], [0, 7, 9, 8, 0, 9], [0, 7, 9, 8, 0, 0], [0, 7, 9, 8, 0, 0], [0, 7, 9, 8, 7, 7], [0, 7, 9, 8, 7, 7], [0, 7, 9, 8, 7, 7], [0, 7, 9, 8, 9, 7], [0, 7, 9, 8, 9, 7], [0, 7, 9, 8, 9, 7], [0, 7, 9, 8, 9, 7], [0, 7, 9, 0, 0, 7], [0, 7, 9, 8, 7, 7], [0, 7, 9, 8, 7, 7], [0, 7, 9, 8, 7, 7], [0, 7, 9, 0, 0, 7], [0, 0, 9, 0, 0, 0], [0, 0, 7, 0, 0, 0], [5, 0, 7, 6, 7, 0], [5, 0, 7, 6, 7, 0], [5, 0, 7, 6, 7, 0], [5, 0, 7, 6, 7, 0], [5, 0, 7, 6, 7, 0], [5, 0, 7, 6, 7, 0], [5, 0, 7, 6, 7, 0], [5, 0, 7, 6, 7, 0], [5, 0, 7, 6, 7, 0], [0, 0, 7, 6, 7, 0], [0, 0, 9, 9, 9, 9], [0, 0, 8, 9, 9, 9], [0, 0, 8, 9, 9, 9], [0, 0, 0, 9, 9, 9], [0, 0, 7, 9, 0, 9], [0, 0, 7, 9, 0, 9], [0, 0, 8, 9, 0, 9], [0, 0, 8, 9, 0, 0], [0, 7, 0, 9, 9, 9], [0, 7, 0, 9, 9, 9], [0, 7, 0, 9, 0, 0], [0, 7, 0, 9, 0, 0], [0, 7, 9, 9, 9, 0], [0, 7, 9, 9, 9, 0], [0, 7, 9, 8, 0, 0], [0, 7, 9, 8, 0, 0], [0, 7, 9, 8, 9, 7], [0, 7, 0, 8, 9, 7], [0, 0, 0, 0, 0, 0], [0, 7, 0, 8, 9, 0], [0, 7, 0, 8, 9, 0], [0, 7, 9, 8, 9, 0], [0, 7, 9, 8, 9, 0], [0, 7, 9, 8, 9, 0], [0, 7, 9, 0, 0, 0], [0, 7, 9, 8, 9, 0], [0, 7, 9, 8, 9, 0], [7, 7, 9, 0, 0, 0], [7, 7, 0, 0, 0, 0], [7, 0, 0, 0, 0, 0], [7, 0, 9, 0, 0, 0], [7, 0, 9, 0, 0, 0], [7, 0, 9, 8, 0, 0], [7, 9, 0, 8, 0, 0], [7, 9, 0, 8, 0, 7], [7, 9, 9, 8, 0, 7], [7, 0, 9, 8, 0, 7], [0, 0, 0, 0, 0, 7], [5, 0, 6, 6, 7, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 0, 0, 0], [5, 0, 7, 6, 0, 0], [5, 0, 7, 6, 0, 0], [5, 0, 7, 6, 0, 0], [5, 6, 7, 6, 0, 0], [0, 6, 8, 0, 0, 0], [0, 7, 8, 8, 9, 0], [0, 7, 0, 8, 9, 0], [0, 7, 0, 8, 7, 0], [0, 7, 9, 8, 7, 0], [0, 7, 9, 8, 7, 0], [0, 7, 9, 8, 7, 0], [0, 7, 9, 8, 7, 0], [0, 0, 0, 0, 0, 0], [0, 7, 9, 8, 7, 0], [0, 7, 9, 8, 7, 0], [0, 7, 0, 8, 9, 0], [0, 7, 0, 8, 9, 0], [0, 0, 0, 8, 9, 0], [0, 0, 0, 8, 0, 0], [0, 0, 9, 8, 9, 7], [0, 0, 9, 8, 9, 7], [0, 0, 9, 8, 9, 7]] 
    #AUDIO_FILE = "02_Funk2-119-G_solo_mic.wav"    
    #test_chords = [[0, 0, 0, 0, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 6, 6, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 9, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 4, 0, 0, 0], [0, 0, 4, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 7, 0, 0, 0], [0, 0, 7, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 6, 6, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 4, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 4, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 4, 0, 0], [0, 0, 0, 4, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 5, 0, 0], [0, 0, 0, 4, 0, 0], [0, 0, 0, 4, 0, 0], [0, 0, 0, 2, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 4, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 4, 0, 0, 0], [0, 0, 4, 0, 0, 0], [0, 0, 4, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 6, 9, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 6, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0], [0, 0, 0, 9, 0, 0], [0, 0, 0, 8, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 9, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 6, 6, 0, 0], [0, 0, 4, 6, 0, 0], [0, 0, 4, 0, 0, 0], [0, 0, 6, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 9, 0, 0, 0], [0, 0, 8, 0, 0, 0], [0, 0, 8, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 6, 0, 0], [0, 0, 0, 0, 0, 0]]
    AUDIO_FILE = "mario.wav"
    
    input_file = os.path.join("./test_inputs", AUDIO_FILE)
    output_file = os.path.join("./test_outputs", "out_" + AUDIO_FILE)

    audio_to_chords_to_audio(model, input_file, MAX_DURATION, playback=True, save_to_file=output_file)

    #create_audio(test_chords, playback=True, save_to_file=output_file)
